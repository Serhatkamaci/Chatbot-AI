<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kübik Chatbot - ChatGPT Benzeri Arayüz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: white;
            border-radius: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #f7f7f8;
            border-right: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
        }

        .new-chat-btn {
            width: 100%;
            background: #10a37f;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #0d8f73;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .kubik-history {
            margin-bottom: 24px;
        }

        .kubik-history h3 {
            color: #374151;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .kubik-item {
            padding: 12px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            group: hover;
        }

        .kubik-item:hover {
            background: #f9f9f9;
            border-color: #10a37f;
        }

        .kubik-item.active {
            background: #10a37f;
            color: white;
        }

        .kubik-main-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kubik-actions {
            display: none;
            gap: 4px;
        }

        .kubik-item:hover .kubik-actions {
            display: flex;
        }

        .kubik-item.active .kubik-actions {
            display: flex;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            padding: 4px 6px;
            cursor: pointer;
            color: inherit;
            font-size: 12px;
            transition: all 0.2s;
        }

        .kubik-item.active .action-btn {
            background: rgba(255, 255, 255, 0.2);
        }

        .kubik-item:not(.active) .action-btn {
            background: rgba(16, 163, 127, 0.1);
            color: #10a37f;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        .main-header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6b7280;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toggle-sidebar:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            flex: 1;
        }

        /* Setup Screen */
        .setup-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }

        .setup-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
        }

        .setup-title {
            text-align: center;
            color: #374151;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .setup-subtitle {
            text-align: center;
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #fafafa;
        }

        .file-upload-area:hover {
            border-color: #10a37f;
            background: #f0fdf4;
        }

        .file-upload-area.dragover {
            border-color: #10a37f;
            background: #f0fdf4;
        }

        .upload-icon {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        .upload-text {
            color: #6b7280;
            font-size: 16px;
        }

        .create-btn {
            width: 100%;
            background: linear-gradient(135deg, #10a37f, #059669);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 16px;
        }

        .create-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(16, 163, 127, 0.3);
        }

        .create-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Chat Screen */
        .chat-screen {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #10a37f;
        }

        .message.assistant .message-avatar {
            background: #6b7280;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            position: relative;
        }

        .message.user .message-content {
            background: #10a37f;
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        .message-text {
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .typing-indicator {
            display: none;
            padding: 16px 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 18px;
            max-width: 70%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Chat Input */
        .chat-input-container {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 20px;
        }

        .chat-input-wrapper {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-input {
            width: 100%;
            min-height: 56px;
            max-height: 200px;
            padding: 16px 60px 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 28px;
            font-size: 16px;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #10a37f;
        }

        .send-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: #10a37f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #0d8f73;
            transform: translateY(-50%) scale(1.05);
        }

        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: #10a37f;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-actions {
            padding: 20px 30px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #10a37f;
            color: white;
        }

        .btn-primary:hover {
            background: #0d8f73;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.success {
            background: #10a37f;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Loading */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10a37f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 100;
                height: 100%;
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
                width: 300px;
            }

            .message-content {
                max-width: 85%;
            }

            .setup-container {
                margin: 20px;
                padding: 24px;
            }
        }

        .file-list {
            margin-top: 16px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            position: relative;
        }

        .file-item i {
            color: #10a37f;
        }

        .file-remove {
            margin-left: auto;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .file-remove:hover {
            background: #dc2626;
        }

        .kubik-files {
            margin-top: 12px;
        }

        .kubik-file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 12px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="showSetup()">
                    <i class="fas fa-plus"></i>
                    Yeni Kübik Oluştur
                </button>
            </div>
            <div class="sidebar-content">
                <div class="kubik-history">
                    <h3><i class="fas fa-history"></i> Kübik Geçmişi</h3>
                    <div id="kubik-history-list">
                        <!-- Dinamik olarak doldurulacak -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <button class="toggle-sidebar" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="chat-title" id="chat-title">Kübik Chatbot</h1>
            </div>

            <!-- Setup Screen -->
            <div class="setup-screen" id="setup-screen">
                <div class="setup-container">
                    <h1 class="setup-title">🚀 Kübik Chatbot</h1>
                    <p class="setup-subtitle">Belgelerinizi yükleyip özel chatbot'unuzu oluşturun</p>

                    <form id="setup-form">
                        <div class="form-group">
                            <label class="form-label" for="kubik-name">
                                <i class="fas fa-cube"></i> Kübik Adı
                            </label>
                            <input
                                type="text"
                                id="kubik-name"
                                class="form-input"
                                placeholder="Örn: proje1, dökümanlar, vs."
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-upload"></i> Dosyalarınızı Yükleyin (PDF, DOCX)
                            </label>
                            <div class="file-upload-area" id="file-upload-area">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="upload-text">
                                    Dosyalarınızı sürükleyip bırakın veya tıklayarak seçin
                                </div>
                                <input
                                    type="file"
                                    id="file-input"
                                    multiple
                                    accept=".pdf,.docx"
                                    style="display: none;"
                                >
                            </div>
                            <div class="file-list" id="file-list"></div>
                        </div>

                        <button type="submit" class="create-btn" id="create-btn">
                            <i class="fas fa-robot"></i> <span id="create-btn-text">Chatbot Oluştur</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Chat Screen -->
            <div class="chat-screen" id="chat-screen">
                <div class="chat-messages" id="chat-messages">
                    <!-- Mesajlar buraya eklenecek -->
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea
                            id="chat-input"
                            class="chat-input"
                            placeholder="Sorularınızı buraya yazın..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kübik Yönetim Modalı -->
    <div id="manage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cogs"></i> Kübik Yönetimi</h2>
                <button class="close" onclick="closeManageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h3 id="manage-kubik-name">Kübik Adı</h3>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Bu kübikteki dosyaları yönetebilirsiniz</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-files"></i> Mevcut Dosyalar
                    </label>
                    <div id="current-files-list">
                        <!-- Mevcut dosyalar buraya eklenecek -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-plus-circle"></i> Yeni Dosya Ekle
                    </label>
                    <div class="file-upload-area" id="manage-file-upload-area">
                        <div class="upload-icon" style="font-size: 24px;">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text" style="font-size: 14px;">
                            Yeni dosyalar ekleyin
                        </div>
                        <input
                            type="file"
                            id="manage-file-input"
                            multiple
                            accept=".pdf,.docx"
                            style="display: none;"
                        >
                    </div>
                    <div class="file-list" id="manage-file-list"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeManageModal()">İptal</button>
                <button class="btn btn-primary" onclick="updateKubik()" id="update-kubik-btn">
                    <i class="fas fa-sync-alt"></i> Kübik'i Güncelle
                </button>
            </div>
        </div>
    </div>

    <!-- Silme Onay Modalı -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-trash"></i> Kübik Silme</h2>
                <button class="close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Bu kübik'i silmek istediğinizden emin misiniz?</p>
                <p style="color: #ef4444; font-weight: 500;" id="delete-kubik-name">Kübik Adı</p>
                <p style="color: #6b7280; font-size: 14px; margin-top: 16px;">Bu işlem geri alınamaz!</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">İptal</button>
                <button class="btn btn-danger" onclick="confirmDelete()" id="confirm-delete-btn">
                    <i class="fas fa-trash"></i> Sil
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global değişkenler
        let currentChatbotId = null;
        let chatHistory = [];
        let isLoading = false;
        let currentManageKubik = null;
        let currentDeleteKubik = null;
        let selectedFiles = [];
        let manageSelectedFiles = [];

        // DOM elementleri
        const setupScreen = document.getElementById('setup-screen');
        const chatScreen = document.getElementById('chat-screen');
        const sidebar = document.getElementById('sidebar');
        const chatTitle = document.getElementById('chat-title');
        const fileInput = document.getElementById('file-input');
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileList = document.getElementById('file-list');
        const setupForm = document.getElementById('setup-form');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const loading = document.getElementById('loading');

        // Modal elementleri
        const manageModal = document.getElementById('manage-modal');
        const deleteModal = document.getElementById('delete-modal');
        const manageFileInput = document.getElementById('manage-file-input');
        const manageFileUploadArea = document.getElementById('manage-file-upload-area');
        const manageFileList = document.getElementById('manage-file-list');

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadKubikHistory();
            setupEventListeners();
        });

        function setupEventListeners() {
            // File upload events
            fileUploadArea.addEventListener('click', () => fileInput.click());
            fileUploadArea.addEventListener('dragover', handleDragOver);
            fileUploadArea.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // Manage modal file upload events
            manageFileUploadArea.addEventListener('click', () => manageFileInput.click());
            manageFileUploadArea.addEventListener('dragover', handleManageDragOver);
            manageFileUploadArea.addEventListener('drop', handleManageFileDrop);
            manageFileInput.addEventListener('change', handleManageFileSelect);

            // Form submit
            setupForm.addEventListener('submit', handleFormSubmit);

            // Chat input events
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            // Modal click outside to close
            window.addEventListener('click', function(e) {
                if (e.target === manageModal) {
                    closeManageModal();
                }
                if (e.target === deleteModal) {
                    closeDeleteModal();
                }
            });
        }

        // Sidebar toggle
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
        }

        // File handling
        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            selectedFiles = files;
            updateFileList(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            selectedFiles = files;
            updateFileList(files);
        }

        // Manage modal file handling
        function handleManageDragOver(e) {
            e.preventDefault();
            manageFileUploadArea.classList.add('dragover');
        }

        function handleManageFileDrop(e) {
            e.preventDefault();
            manageFileUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            manageSelectedFiles = [...manageSelectedFiles, ...files];
            updateManageFileList();
        }

        function handleManageFileSelect(e) {
            const files = Array.from(e.target.files);
            manageSelectedFiles = [...manageSelectedFiles, ...files];
            updateManageFileList();
        }

        function updateFileList(files) {
            fileList.innerHTML = '';
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <i class="fas fa-file-${file.type.includes('pdf') ? 'pdf' : 'word'}"></i>
                    <span>${file.name}</span>
                    <span style="margin-left: auto; color: #6b7280;">${formatFileSize(file.size)}</span>
                    <button class="file-remove" onclick="removeFile(${index})">×</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function updateManageFileList() {
            manageFileList.innerHTML = '';
            manageSelectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <i class="fas fa-file-${file.type.includes('pdf') ? 'pdf' : 'word'}"></i>
                    <span>${file.name}</span>
                    <span style="margin-left: auto; color: #6b7280;">${formatFileSize(file.size)}</span>
                    <button class="file-remove" onclick="removeManageFile(${index})">×</button>
                `;
                manageFileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList(selectedFiles);
        }

        function removeManageFile(index) {
            manageSelectedFiles.splice(index, 1);
            updateManageFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submit
        async function handleFormSubmit(e) {
            e.preventDefault();

            const kubikName = document.getElementById('kubik-name').value.trim();

            if (!kubikName) {
                showNotification('Lütfen kübik adı girin', 'error');
                return;
            }

            if (!selectedFiles.length) {
                showNotification('Lütfen en az bir dosya seçin', 'error');
                return;
            }

            setLoading(true);
            document.getElementById('create-btn-text').textContent = 'Oluşturuluyor...';

            try {
                const formData = new FormData();
                formData.append('kubik_name', kubikName);

                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                const response = await fetch('/api/kubik/create', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentChatbotId = result.chatbot_id;
                    chatHistory = [];
                    showChat(result.kubik_name);
                    loadKubikHistory();
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Bir hata oluştu: ' + error.message, 'error');
            }

            setLoading(false);
            document.getElementById('create-btn-text').textContent = 'Chatbot Oluştur';
        }

        // Kübik geçmişini yükle
        async function loadKubikHistory() {
            try {
                const response = await fetch('/api/kubik/history');
                const result = await response.json();

                if (result.success) {
                    const historyList = document.getElementById('kubik-history-list');

                    if (result.history.length === 0) {
                        historyList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-cube"></i>
                                <p>Henüz kübik yok</p>
                            </div>
                        `;
                        return;
                    }

                    historyList.innerHTML = '';

                    for (const kubik of result.history) {
                        try {
                            // Her kübik için dosya bilgilerini al
                            const infoResponse = await fetch(`/api/kubik/info/${kubik}`);
                            const infoResult = await infoResponse.json();

                            const kubikItem = document.createElement('div');
                            kubikItem.className = 'kubik-item';
                            kubikItem.innerHTML = `
                                <div class="kubik-main-content" onclick="loadKubik('${kubik}')">
                                    <i class="fas fa-cube"></i>
                                    <div>
                                        <div style="font-weight: 500;">${kubik}</div>
                                        <div class="kubik-files">
                                            ${infoResult.success && infoResult.files ?
                                                infoResult.files.slice(0, 2).map(file =>
                                                    `<div class="kubik-file-item">
                                                        <i class="fas fa-file-${file.includes('.pdf') ? 'pdf' : 'word'}"></i>
                                                        <span>${file}</span>
                                                    </div>`
                                                ).join('') +
                                                (infoResult.files.length > 2 ? `<div class="kubik-file-item" style="color: #10a37f;">+${infoResult.files.length - 2} dosya daha</div>` : '')
                                                : '<div class="kubik-file-item">Dosya bilgisi yok</div>'
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="kubik-actions">
                                    <button class="action-btn" onclick="event.stopPropagation(); openManageModal('${kubik}')" title="Yönet">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="action-btn" onclick="event.stopPropagation(); openDeleteModal('${kubik}')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            historyList.appendChild(kubikItem);
                        } catch (error) {
                            console.error(`${kubik} için bilgi alınamadı:`, error);
                            // Basit görünüm ekle
                            const kubikItem = document.createElement('div');
                            kubikItem.className = 'kubik-item';
                            kubikItem.innerHTML = `
                                <div class="kubik-main-content" onclick="loadKubik('${kubik}')">
                                    <i class="fas fa-cube"></i>
                                    <span>${kubik}</span>
                                </div>
                                <div class="kubik-actions">
                                    <button class="action-btn" onclick="event.stopPropagation(); openManageModal('${kubik}')" title="Yönet">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="action-btn" onclick="event.stopPropagation(); openDeleteModal('${kubik}')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            historyList.appendChild(kubikItem);
                        }
                    }
                }
            } catch (error) {
                console.error('Geçmiş yüklenirken hata:', error);
            }
        }

        // Kübiği yükle
        async function loadKubik(kubikName) {
            setLoading(true);

            try {
                const response = await fetch(`/api/kubik/load/${kubikName}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    currentChatbotId = result.chatbot_id;
                    chatHistory = [];
                    showChat(result.kubik_name);
                    showNotification(result.message, 'success');

                    // Aktif kubik'i işaretle
                    document.querySelectorAll('.kubik-item').forEach(item => {
                        item.classList.remove('active');
                        const kubikMainContent = item.querySelector('.kubik-main-content');
                        if (kubikMainContent && kubikMainContent.textContent.includes(kubikName)) {
                            item.classList.add('active');
                        }
                    });
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Kübik yüklenirken hata: ' + error.message, 'error');
            }

            setLoading(false);
        }

        // Modal işlemleri
        function openManageModal(kubikName) {
            currentManageKubik = kubikName;
            document.getElementById('manage-kubik-name').textContent = kubikName;
            manageSelectedFiles = [];
            updateManageFileList();
            loadCurrentFiles(kubikName);
            manageModal.style.display = 'block';
        }

        function closeManageModal() {
            manageModal.style.display = 'none';
            currentManageKubik = null;
            manageSelectedFiles = [];
            updateManageFileList();
        }

        function openDeleteModal(kubikName) {
            currentDeleteKubik = kubikName;
            document.getElementById('delete-kubik-name').textContent = kubikName;
            deleteModal.style.display = 'block';
        }

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
            currentDeleteKubik = null;
        }

        async function loadCurrentFiles(kubikName) {
            try {
                const response = await fetch(`/api/kubik/info/${kubikName}`);
                const result = await response.json();

                const currentFilesList = document.getElementById('current-files-list');

                if (result.success && result.files && result.files.length > 0) {
                    currentFilesList.innerHTML = '';
                    result.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <i class="fas fa-file-${file.includes('.pdf') ? 'pdf' : 'word'}"></i>
                            <span>${file}</span>
                            <button class="file-remove" onclick="removeCurrentFile('${kubikName}', '${file}')">×</button>
                        `;
                        currentFilesList.appendChild(fileItem);
                    });
                } else {
                    currentFilesList.innerHTML = '<p style="color: #6b7280;">Dosya bilgisi alınamadı</p>';
                }
            } catch (error) {
                console.error('Dosyalar yüklenemedi:', error);
                document.getElementById('current-files-list').innerHTML = '<p style="color: #ef4444;">Dosyalar yüklenemedi</p>';
            }
        }

        async function removeCurrentFile(kubikName, fileName) {
            try {
                const response = await fetch(`/api/kubik/remove-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        kubik_name: kubikName,
                        file_name: fileName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Dosya silindi', 'success');
                    loadCurrentFiles(kubikName);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Dosya silinemedi: ' + error.message, 'error');
            }
        }

        async function updateKubik() {
            if (!currentManageKubik) return;

            if (manageSelectedFiles.length === 0) {
                showNotification('Yeni dosya seçmediniz', 'error');
                return;
            }

            setLoading(true);
            document.getElementById('update-kubik-btn').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Güncelleniyor...';

            try {
                const formData = new FormData();
                formData.append('kubik_name', currentManageKubik);

                manageSelectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                const response = await fetch('/api/kubik/update', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    closeManageModal();
                    loadKubikHistory();
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Güncelleme hatası: ' + error.message, 'error');
            }

            setLoading(false);
            document.getElementById('update-kubik-btn').innerHTML = '<i class="fas fa-sync-alt"></i> Kübik\'i Güncelle';
        }

        async function confirmDelete() {
            if (!currentDeleteKubik) return;

            setLoading(true);
            document.getElementById('confirm-delete-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Siliniyor...';

            try {
                const response = await fetch(`/api/kubik/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        kubik_name: currentDeleteKubik
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    closeDeleteModal();
                    loadKubikHistory();

                    // Eğer silinen kübik aktifse, setup ekranına dön
                    if (chatTitle.textContent.includes(currentDeleteKubik)) {
                        showSetup();
                    }
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Silme hatası: ' + error.message, 'error');
            }

            setLoading(false);
            document.getElementById('confirm-delete-btn').innerHTML = '<i class="fas fa-trash"></i> Sil';
        }

        // Chat göster
        function showChat(kubikName) {
            setupScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            chatTitle.textContent = `💬 ${kubikName}`;
            chatMessages.innerHTML = '';
            chatInput.value = '';
        }

        // Setup göster
        function showSetup() {
            setupScreen.style.display = 'flex';
            chatScreen.style.display = 'none';
            chatTitle.textContent = 'Kübik Chatbot';

            // Form reset
            document.getElementById('setup-form').reset();
            selectedFiles = [];
            updateFileList(selectedFiles);

            // Aktif kubik işaretini kaldır
            document.querySelectorAll('.kubik-item').forEach(item => {
                item.classList.remove('active');
            });

            currentChatbotId = null;
            chatHistory = [];
        }

        // Mesaj gönder
        async function sendMessage() {
            const message = chatInput.value.trim();

            if (!message || !currentChatbotId || isLoading) {
                return;
            }

            // Kullanıcı mesajını ekle
            addMessage('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // Typing indicator göster
            showTypingIndicator();

            isLoading = true;
            sendBtn.disabled = true;

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatbot_id: currentChatbotId,
                        message: message,
                        history: chatHistory
                    })
                });

                const result = await response.json();

                hideTypingIndicator();

                if (result.success) {
                    addMessage('assistant', result.response);
                } else {
                    addMessage('assistant', 'Üzgünüm, bir hata oluştu: ' + result.message);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', 'Üzgünüm, bağlantı hatası oluştu.');
            }

            isLoading = false;
            sendBtn.disabled = false;
        }

        // Mesaj ekle
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = content;

            contentDiv.appendChild(textDiv);

            if (role === 'user') {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatarDiv);
            } else {
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Geçmişe ekle
            chatHistory.push({ role: role, content: content });
        }

        // Typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';

            const typingContent = document.createElement('div');
            typingContent.className = 'typing-indicator';
            typingContent.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            typingContent.style.display = 'block';

            typingDiv.appendChild(avatarDiv);
            typingDiv.appendChild(typingContent);

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Utility functions
        function setLoading(loading) {
            document.getElementById('loading').style.display = loading ? 'block' : 'none';
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>